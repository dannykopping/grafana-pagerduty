{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","id","name","q","doRequest","method","then","response","status","message","title","catch","options","result","i","data","incidents","length","d","annotation","serviceId","service","urgency","created_at","Date","parse","annotation_end","last_status_change_at","now","incident","enabled","datasource","time","isRegion","timeEnd","tags","incident_key","incident_number","text","html_url","filter","el","push","queryString","range","from","toISOString","to","transformResponse","datasourceRequest"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = `/api/datasources/proxy/${instanceSettings.id}/pagerduty/incidents`;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url,\n      method: \"GET\",\n    }).then(response => {\n      if (response.status === 200) {\n        return { \n            status: \"success\", \n            message: \"Data source is working\",\n            title: \"Success\" \n        };\n      }\n    }).catch(response => {\n      return { \n          status: \"error\", \n          message: `Data source is not working (code: ${response.status})`,\n          title: \"Error\" \n      };\n    });\n  }\n\n  transformResponse(response, options) {\n    var result = [];\n    for(var i = 0; i < response.data.incidents.length; i++){\n        var d = response.data.incidents[i];\n        if (options.annotation.serviceId && d.service.id != options.annotation.serviceId) {\n            continue;\n        }\n        if (options.annotation.urgency && d.urgency != options.annotation.urgency) {\n            continue;\n        }\n        if (options.annotation.status && d.status != options.annotation.status) {\n            continue;\n        }\n        var created_at = Date.parse(d.created_at);\n\n        var annotation_end = (d.status === 'resolved')? Date.parse(d.last_status_change_at) : Date.now();\n\n        var incident = { annotation:\n            { name: d.id,\n              enabled: true,\n              datasource: \"grafana-pagerduty\"\n            },\n            title: d.title,\n            time: created_at,\n            isRegion: true,\n            timeEnd: annotation_end,\n            tags: [ d.type, d.incident_key, d.incident_number, d.status, d.service.id ],\n            text: '<a target=\"_blank\" href=\"' + d.html_url + '\">PagerDuty incident page</a>',\n        };\n\n        incident.tags = incident.tags.filter(function (el) {\n            return el != null;\n        });\n\n        result.push(incident);\n    }\n    return result;\n  }\n\n  annotationQuery(options) {\n    var queryString = \"\";\n\n    queryString += \"&since=\" + new Date(options.range.from).toISOString();\n    queryString += \"&until=\" + new Date(options.range.to).toISOString();\n\n    return this.doRequest({\n      url: `${this.url}?time_zone=UTC${queryString}`,\n      method: 'GET'\n    }).then(response => {\n        var result = this.transformResponse(response, options);\n        return result;\n    }).catch(response => {\n        return [];\n    });\n  }\n\n  doRequest(options) {\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n}\n"]}