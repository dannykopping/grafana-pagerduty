{"version":3,"sources":["../../src/datasource.js"],"names":["GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","id","name","q","doRequest","method","then","response","status","message","title","catch","options","result","i","data","incidents","length","d","annotation","serviceId","service","urgency","created_at","Date","parse","annotation_end","last_status_change_at","now","incident","enabled","datasource","time","isRegion","timeEnd","tags","incident_key","incident_number","text","html_url","filter","el","push","queryString","range","from","toISOString","to","transformResponse","datasourceRequest"],"mappings":";;;;;;;;;AAAA;;;;;;;;IAEaA,iB,WAAAA,iB;AAEX,6BAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8CC,WAA9C,EAA2D;AAAA;;AACzD,SAAKC,IAAL,GAAYJ,iBAAiBI,IAA7B;AACA,SAAKC,GAAL,+BAAqCL,iBAAiBM,EAAtD;AACA,SAAKC,IAAL,GAAYP,iBAAiBO,IAA7B;AACA,SAAKC,CAAL,GAASP,EAAT;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACD;;;;qCAEgB;AACf,aAAO,KAAKM,SAAL,CAAe;AACpBJ,aAAK,KAAKA,GADU;AAEpBK,gBAAQ;AAFY,OAAf,EAGJC,IAHI,CAGC,oBAAY;AAClB,YAAIC,SAASC,MAAT,KAAoB,GAAxB,EAA6B;AAC3B,iBAAO;AACHA,oBAAQ,SADL;AAEHC,qBAAS,wBAFN;AAGHC,mBAAO;AAHJ,WAAP;AAKD;AACF,OAXM,EAWJC,KAXI,CAWE,oBAAY;AACnB,eAAO;AACHH,kBAAQ,OADL;AAEHC,0DAA8CF,SAASC,MAAvD,MAFG;AAGHE,iBAAO;AAHJ,SAAP;AAKD,OAjBM,CAAP;AAkBD;;;sCAEiBH,Q,EAAUK,O,EAAS;AACnC,UAAIC,SAAS,EAAb;AACA,WAAI,IAAIC,IAAI,CAAZ,EAAeA,IAAIP,SAASQ,IAAT,CAAcC,SAAd,CAAwBC,MAA3C,EAAmDH,GAAnD,EAAuD;AACnD,YAAII,IAAIX,SAASQ,IAAT,CAAcC,SAAd,CAAwBF,CAAxB,CAAR;AACA,YAAIF,QAAQO,UAAR,CAAmBC,SAAnB,IAAgCF,EAAEG,OAAF,CAAUpB,EAAV,IAAgBW,QAAQO,UAAR,CAAmBC,SAAvE,EAAkF;AAC9E;AACH;AACD,YAAIR,QAAQO,UAAR,CAAmBG,OAAnB,IAA8BJ,EAAEI,OAAF,IAAaV,QAAQO,UAAR,CAAmBG,OAAlE,EAA2E;AACvE;AACH;AACD,YAAIV,QAAQO,UAAR,CAAmBX,MAAnB,IAA6BU,EAAEV,MAAF,IAAYI,QAAQO,UAAR,CAAmBX,MAAhE,EAAwE;AACpE;AACH;AACD,YAAIe,aAAaC,KAAKC,KAAL,CAAWP,EAAEK,UAAb,CAAjB;;AAEA,YAAIG,iBAAkBR,EAAEV,MAAF,KAAa,UAAd,GAA2BgB,KAAKC,KAAL,CAAWP,EAAES,qBAAb,CAA3B,GAAiEH,KAAKI,GAAL,EAAtF;;AAEA,YAAIC,WAAW,EAAEV,YACb,EAAEjB,MAAMgB,EAAEjB,EAAV;AACE6B,qBAAS,IADX;AAEEC,wBAAY;AAFd,WADW;AAKXrB,iBAAOQ,EAAER,KALE;AAMXsB,gBAAMT,UANK;AAOXU,oBAAU,IAPC;AAQXC,mBAASR,cARE;AASXS,gBAAM,CAAEjB,EAAEnB,IAAJ,EAAUmB,EAAEkB,YAAZ,EAA0BlB,EAAEmB,eAA5B,EAA6CnB,EAAEV,MAA/C,EAAuDU,EAAEG,OAAF,CAAUpB,EAAjE,CATK;AAUXqC,gBAAM,8BAA8BpB,EAAEqB,QAAhC,GAA2C;AAVtC,SAAf;;AAaAV,iBAASM,IAAT,GAAgBN,SAASM,IAAT,CAAcK,MAAd,CAAqB,UAAUC,EAAV,EAAc;AAC/C,iBAAOA,MAAM,IAAb;AACH,SAFe,CAAhB;;AAIA5B,eAAO6B,IAAP,CAAYb,QAAZ;AACH;AACD,aAAOhB,MAAP;AACD;;;oCAEeD,O,EAAS;AAAA;;AACvB,UAAI+B,cAAc,EAAlB;;AAEAA,qBAAe,YAAY,IAAInB,IAAJ,CAASZ,QAAQgC,KAAR,CAAcC,IAAvB,EAA6BC,WAA7B,EAA3B;AACAH,qBAAe,YAAY,IAAInB,IAAJ,CAASZ,QAAQgC,KAAR,CAAcG,EAAvB,EAA2BD,WAA3B,EAA3B;;AAEA,aAAO,KAAK1C,SAAL,CAAe;AACpBJ,aAAQ,KAAKA,GAAb,sBAAiC2C,WADb;AAEpBtC,gBAAQ;AAFY,OAAf,EAGJC,IAHI,CAGC,oBAAY;AAChB,YAAIO,SAAS,MAAKmC,iBAAL,CAAuBzC,QAAvB,EAAiCK,OAAjC,CAAb;AACA,eAAOC,MAAP;AACH,OANM,EAMJF,KANI,CAME,oBAAY;AACjB,eAAO,EAAP;AACH,OARM,CAAP;AASD;;;8BAESC,O,EAAS;AACjB,aAAO,KAAKf,UAAL,CAAgBoD,iBAAhB,CAAkCrC,OAAlC,CAAP;AACD","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = `/api/datasources/proxy/${instanceSettings.id}/pagerduty/incidents`;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url,\n      method: \"GET\",\n    }).then(response => {\n      if (response.status === 200) {\n        return { \n            status: \"success\", \n            message: \"Data source is working\",\n            title: \"Success\" \n        };\n      }\n    }).catch(response => {\n      return { \n          status: \"error\", \n          message: `Data source is not working (code: ${response.status})`,\n          title: \"Error\" \n      };\n    });\n  }\n\n  transformResponse(response, options) {\n    var result = [];\n    for(var i = 0; i < response.data.incidents.length; i++){\n        var d = response.data.incidents[i];\n        if (options.annotation.serviceId && d.service.id != options.annotation.serviceId) {\n            continue;\n        }\n        if (options.annotation.urgency && d.urgency != options.annotation.urgency) {\n            continue;\n        }\n        if (options.annotation.status && d.status != options.annotation.status) {\n            continue;\n        }\n        var created_at = Date.parse(d.created_at);\n\n        var annotation_end = (d.status === 'resolved')? Date.parse(d.last_status_change_at) : Date.now();\n\n        var incident = { annotation:\n            { name: d.id,\n              enabled: true,\n              datasource: \"grafana-pagerduty\"\n            },\n            title: d.title,\n            time: created_at,\n            isRegion: true,\n            timeEnd: annotation_end,\n            tags: [ d.type, d.incident_key, d.incident_number, d.status, d.service.id ],\n            text: '<a target=\"_blank\" href=\"' + d.html_url + '\">PagerDuty incident page</a>',\n        };\n\n        incident.tags = incident.tags.filter(function (el) {\n            return el != null;\n        });\n\n        result.push(incident);\n    }\n    return result;\n  }\n\n  annotationQuery(options) {\n    var queryString = \"\";\n\n    queryString += \"&since=\" + new Date(options.range.from).toISOString();\n    queryString += \"&until=\" + new Date(options.range.to).toISOString();\n\n    return this.doRequest({\n      url: `${this.url}?time_zone=UTC${queryString}`,\n      method: 'GET'\n    }).then(response => {\n        var result = this.transformResponse(response, options);\n        return result;\n    }).catch(response => {\n        return [];\n    });\n  }\n\n  doRequest(options) {\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n}\n"]}